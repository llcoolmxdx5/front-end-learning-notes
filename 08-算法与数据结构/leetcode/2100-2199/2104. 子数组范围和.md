# [2104. 子数组范围和](https://leetcode-cn.com/problems/sum-of-subarray-ranges/)

## 题目

给你一个整数数组 `nums` 。`nums` 中，子数组的**范围**是子数组中最大元素和最小元素的差值。

返回 `nums` 中**所有**子数组范围的**和**。

子数组是数组中一个连续**非空**的元素序列。

示例 1：

```txt
输入：nums = [1,2,3]
输出：4
解释：nums 的 6 个子数组如下所示：
[1]，范围 = 最大 - 最小 = 1 - 1 = 0
[2]，范围 = 2 - 2 = 0
[3]，范围 = 3 - 3 = 0
[1,2]，范围 = 2 - 1 = 1
[2,3]，范围 = 3 - 2 = 1
[1,2,3]，范围 = 3 - 1 = 2
所有范围的和是 0 + 0 + 0 + 1 + 1 + 2 = 4
```

示例 2：

```txt
输入：nums = [1,3,3]
输出：4
解释：nums 的 6 个子数组如下所示：
[1]，范围 = 最大 - 最小 = 1 - 1 = 0
[3]，范围 = 3 - 3 = 0
[3]，范围 = 3 - 3 = 0
[1,3]，范围 = 3 - 1 = 2
[3,3]，范围 = 3 - 3 = 0
[1,3,3]，范围 = 3 - 1 = 2
所有范围的和是 0 + 0 + 0 + 2 + 0 + 2 = 4
```

示例 3：

```txt
输入：nums = [4,-2,-3,4,1]
输出：59
解释：nums 中所有子数组范围的和是 59
```

提示：

- `1 <= nums.length <= 1000`
- `-10^9 <= nums[i] <= 10^9`

进阶：你可以设计一种时间复杂度为 `O(n)` 的解决方案吗？

## 难度

中等

## 标签

栈 数组 单调栈

## 解题思路

### 方法一：遍历子数组

`O(n^2)`

### 方法二：单调栈

以最大值为例，我们可以求出每个元素为最大值时的区间范围，比如，假设给定数组为 `[1,1,2,1,3]` ，那么，元素 2 作为最大值时的范围为多少呢？显然下标范围为 `[0, 3]`，那么，以 2 为最大值的子数组有多少个呢？答案是 6 个，为 2 左边的元素个数 乘以 2 右边元素的个数，两边都要包含 2，即为 `3 * 2 = 6`，这个也很好理解，我们需要在两边各取一个下标才能形成一个包含 2 的子数组，左边有三种取法，右边有两种取法，所以，是 6 种方式。

那么，现在我们的问题就来到了，如何求出每个元素作为最大值时的范围，具体地，是左范围的元素个数和右范围的元素个数。

这里，我们可以使用单调栈来求解。

还是以最大值为例，我们使用一个单调递减栈，遇到比栈顶元素小的，直接入栈，遇到比栈顶元素大的，就要开始计算，具体的计算过程，栈顶元素下面一个元素到栈顶元素的范围就是左范围，栈顶元素到当前元素的范围就是右范围，所以，我们的栈里面需要存储下标，这样我们就可以很方便地计算出来左范围元素的个数及右范围元素的个数。

这里为了方便，我们可以先在栈中存一个 -1 的下标。

> 注：栈里存储的是下标，所以，肯定是递增的，但是，下标对应的元素值是递减的，所以，我们叫单调递减栈。

最小值的求解过程正好是反过来的。

我们只要求出了 最大值和 及 最小值和，两者相减就题目的结果

## 提交速度

- 执行用时：`76 ms`, 在所有 JavaScript 提交中击败了`93.66%`的用户
- 内存消耗：`42.1 MB`, 在所有 JavaScript 提交中击败了`26.67%`的用户
